// Generated by CoffeeScript 1.6.3
(function() {
  var DOMReady, canvas, context, drawImage, getData, getQuery, id, imgPointer, imgStack, infoEl, isPlaying, next, pause, previous, progressEl, rows, siteCodeEl, updateProgress;

  imgStack = [];

  rows = null;

  imgPointer = 0;

  canvas = null;

  context = null;

  isPlaying = false;

  id = null;

  progressEl = null;

  infoEl = null;

  siteCodeEl = null;

  updateProgress = function() {
    var progress, width;
    width = 600;
    progress = width * (imgPointer / (imgStack.length - 1));
    return progressEl.css('width', progress);
  };

  drawImage = function(src) {
    var img;
    img = new Image();
    img.onload = function(e) {
      return context.drawImage(img, 0, 0);
    };
    return img.src = src;
  };

  previous = function() {
    if (imgStack.length === 0) {
      return false;
    }
    if (imgPointer === 0) {
      return false;
    }
    imgPointer -= 1;
    drawImage(imgStack[imgPointer]);
    updateProgress();
    return true;
  };

  next = function() {
    if (imgStack.length === 0) {
      return false;
    }
    if (imgPointer === (imgStack.length - 1)) {
      return false;
    }
    imgPointer += 1;
    siteCodeEl.text(rows[imgPointer].site_code);
    infoEl.text(rows[imgPointer].imgurl);
    drawImage(imgStack[imgPointer]);
    updateProgress();
    return true;
  };

  pause = function() {
    if (id === null) {
      return;
    }
    isPlaying = false;
    clearInterval(id);
    return id = null;
  };

  getQuery = function(query) {
    var url;
    url = encodeURI("https://aliburchard.cartodb.com/api/v2/sql?q=" + query);
    return url.replace(/\+/g, '%2B');
  };

  getData = function(url) {
    return $.ajax(url).done(function(data) {
      imgPointer = 0;
      infoEl.text('');
      canvas.width = canvas.width;
      rows = data.rows;
      imgStack = rows.map(function(d) {
        return d.imgurl;
      });
      updateProgress();
      if (imgStack.length === 0) {
        infoEl.text("No images.");
        return;
      }
      return drawImage(imgStack[imgPointer]);
    });
  };

  DOMReady = function() {
    var filters;
    canvas = document.querySelector('#flipbook');
    context = canvas.getContext('2d');
    progressEl = $('div.progress');
    infoEl = $("p.info");
    siteCodeEl = $("p.site-code");
    filters = {
      species: '',
      site: ''
    };
    $("select[data-filter='species']").on('change', function(e) {
      var query, url, value;
      pause();
      value = e.target.value;
      if (value === '') {
        return;
      }
      filters.species = value;
      if (filters.site === '') {
        query = "SELECT * FROM ss_cons_coords WHERE species ILIKE '%" + filters.species + "%' ORDER BY timestamp_proc";
      } else {
        query = "SELECT * FROM ss_cons_coords WHERE species ILIKE '%" + filters.species + "%' AND site_code = '" + filters.site + "' ORDER BY timestamp_proc";
      }
      url = getQuery(query);
      return getData(url);
    });
    $("select[data-filter='site']").on('change', function(e) {
      var query, url, value;
      pause();
      value = e.target.value;
      if (value === '') {
        return;
      }
      filters.site = value;
      if (filters.species === '') {
        query = "SELECT * FROM ss_cons_coords WHERE site_code = '" + filters.site + "' ORDER BY timestamp_proc";
      } else {
        query = "SELECT * FROM ss_cons_coords WHERE species ILIKE '%" + filters.species + "%' AND site_code = '" + filters.site + "' ORDER BY timestamp_proc";
      }
      url = getQuery(query);
      return getData(url);
    });
    $("button.prev").on('click', previous);
    $("button.next").on('click', next);
    $("button.reset").on('click', function(e) {
      imgPointer = 0;
      drawImage(imgStack[imgPointer]);
      return updateProgress();
    });
    $("button.pause").on('click', pause);
    return $("button.play").on('click', function(e) {
      if (isPlaying) {
        return;
      }
      isPlaying = true;
      return id = setInterval((function() {
        if (!next()) {
          clearInterval(id);
          return isPlaying = false;
        }
      }), 50);
    });
  };

  window.addEventListener('DOMContentLoaded', DOMReady, false);

}).call(this);
