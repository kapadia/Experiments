// Generated by CoffeeScript 1.6.3
(function() {
  var PEERPORT, PORT, PeerServer, app, express, getRoomCounts, http, io, peerServer, server, socketio;

  PeerServer = require('peer').PeerServer;

  express = require('express');

  http = require('http');

  socketio = require('socket.io');

  PORT = 8000;

  PEERPORT = 9000;

  app = express();

  server = http.createServer(app);

  io = socketio.listen(server, {
    log: false
  });

  server.listen(PORT);

  peerServer = new PeerServer({
    port: PEERPORT
  });

  console.log("Express server listening on port " + PORT);

  console.log("Peer server listening on port " + PEERPORT);

  app.use(express["static"]("" + __dirname + "/../"));

  getRoomCounts = function(io, socket) {
    var counts;
    counts = {};
    return setImmediate((function() {
      var k, rooms, v, _ref;
      rooms = io.sockets.manager.roomClients[socket.id];
      _ref = io.sockets.manager.rooms;
      for (k in _ref) {
        v = _ref[k];
        counts[k] = v.length;
      }
      return io.sockets.emit('set-room-count', {
        roomCounts: counts,
        rooms: rooms
      });
    }));
  };

  io.sockets.on('connection', function(socket) {
    socket.on('disconnect', function() {
      return getRoomCounts(io, socket);
    });
    socket.emit("status", {
      status: true
    });
    getRoomCounts(io, socket);
    return socket.on('create-room', function(name) {
      socket.join(name);
      return getRoomCounts(io, socket);
    });
  });

}).call(this);
